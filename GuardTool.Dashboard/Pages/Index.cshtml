@page
@{
    ViewData["Title"] = "Events";
}

<div class="card">
  <div class="header-row">
    <div>
      <h1 class="h1">Events</h1>
      <div id="noReportsMsg" class="small muted" style="display:none;margin-top:6px;">
        No reports found yet. Run a scan to generate at least 1 report.
      </div>
    </div>
    <div class="actions">
      <a class="btn" id="reportsBtn" href="/Reports">Reports</a>
      <button class="btn filter-btn" onclick="openDrawer()">Filter</button>
    </div>
  </div>

  <div id="runScanCard" class="card" style="margin-top:14px; display:none;">
  <div class="header-row" style="margin-bottom:10px;">
    <div>
      <div style="font-weight:700;font-size:18px;">No reports yet</div>
      <div class="small muted">Run a scan to generate the first report. Then Reports/Downloads will unlock.</div>
    </div>
    <div class="actions">
      <button class="btn primary" onclick="showScanCommand()">Run scan</button>
    </div>
  </div>

  <div id="scanCmdWrap" style="display:none;">
    <div class="small muted" style="margin-bottom:8px;">Copy & run this command in PowerShell (project root):</div>
    <div class="codebox" id="scanCmd"></div>
    <div class="actions" style="margin-top:10px;">
      <button class="btn" onclick="copyScanCmd()">Copy</button>
      <a class="btn" href="/Reports" id="goReportsAfter" style="display:none;">Go to Reports</a>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

  <table class="table">
    <thead class="thead">
      <tr>
        <th class="sortable" data-sort="name">Name</th>
        <th class="sortable" data-sort="risk">Risk</th>
        <th class="sortable" data-sort="grade">Grade</th>
        <th class="sortable" data-sort="score">Score</th>
        <th class="sortable" data-sort="status">Status</th>
        <th>Counts</th>
        <th class="sortable" data-sort="newCritical">New Crit</th>
        <th class="sortable" data-sort="timestamp">Created</th>
        <th>Open</th>
      </tr>
    </thead>
    <tbody id="tb"></tbody>
  </table>
</div>

<!-- Filter Drawer -->
<div id="backdrop" class="drawer-backdrop" onclick="closeDrawer()"></div>
<aside id="drawer" class="drawer">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
    <h2>Filter</h2>
    <button class="btn" onclick="closeDrawer()">Close</button>
  </div>

  <div class="row">
    <input class="input" id="q" placeholder="Search name/status/grade..." />
  </div>

  <div class="row">
    <select class="select" id="minGrade">
      <option value="">Min grade</option>
      <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="F">F</option>
    </select>

    <select class="select" id="status">
      <option value="">Any status</option>
      <option value="Critical">Critical</option>
      <option value="Warn">Warn</option>
      <option value="Ok">Ok</option>
    </select>
  </div>

  <div class="row">
    <select class="select" id="onlyNewCrit">
      <option value="">Only new Critical?</option>
      <option value="1">Yes</option>
    </select>

    <select class="select" id="sort">
      <option value="timestamp_desc">Sort: Newest</option>
      <option value="timestamp_asc">Sort: Oldest</option>
      <option value="risk_desc">Sort: Risk high→low</option>
      <option value="risk_asc">Sort: Risk low→high</option>
      <option value="score_desc">Sort: Score high→low</option>
      <option value="score_asc">Sort: Score low→high</option>
    </select>
  </div>

  <div class="hr"></div>

  <div class="row">
    <button class="btn primary" onclick="applyFilters()">Apply</button>
    <button class="btn" onclick="resetFilters()">Reset</button>
  </div>

  <div class="small muted">Tip: table headers are clickable for quick sorting.</div>
</aside>

<script>
let _sortKey = "timestamp";
let _sortDir = "desc";

async function load(){
  const res = await fetch('/api/reports?root=' + encodeURIComponent(window.location.pathname));
  window._reports = await res.json();
  const hasReports = (window._reports || []).length > 0;
  const rb = document.getElementById('reportsBtn');
  if (rb && !hasReports) rb.classList.add('disabled-link');
  const msg = document.getElementById('noReportsMsg');
  if(msg) msg.style.display = hasReports ? 'none' : '';

  // ✅ rapor yoksa Run Scan kartını göster
  const rsc = document.getElementById('runScanCard');
  if(rsc) rsc.style.display = hasReports ? 'none' : '';

  // ✅ rapor varsa “Go to Reports” butonunu göster
  const go = document.getElementById('goReportsAfter');
  if(go) go.style.display = hasReports ? '' : 'none';
  render();
}

function rank(g){ return ({'A':5,'B':4,'C':3,'D':2,'F':1}[g]||0); }
function riskPct(score){
  const s = (score ?? 100);
  const r = Math.max(0, Math.min(100, 100 - s));
  return r;
}

function gradeClass(g){ return g ? ("grade-" + g) : ""; }

function statusClass(s){
  // Senin status zaten "Critical" yazıyor gibi; Warn/Ok varsa renklensin
  if(!s) return "";
  return "status-" + String(s).replace(/\s+/g,'');
}

function openDrawer(){
  document.getElementById('backdrop').classList.add('open');
  document.getElementById('drawer').classList.add('open');
}
function closeDrawer(){
  document.getElementById('backdrop').classList.remove('open');
  document.getElementById('drawer').classList.remove('open');
}

function applyFilters(){
  // drawer sort dropdown: "risk_desc" gibi
  const sort = document.getElementById('sort').value || "timestamp_desc";
  const [k, d] = sort.split("_");
  _sortKey = (k === "timestamp") ? "timestamp" : k;
  _sortDir = d || "desc";
  render();
  closeDrawer();
}

function resetFilters(){
  document.getElementById('q').value = "";
  document.getElementById('minGrade').value = "";
  document.getElementById('status').value = "";
  document.getElementById('onlyNewCrit').value = "";
  document.getElementById('sort').value = "timestamp_desc";
  _sortKey = "timestamp"; _sortDir = "desc";
  render();
}

function getFilters(){
  return {
    q: (document.getElementById('q').value||'').toLowerCase(),
    minGrade: document.getElementById('minGrade').value || "",
    status: document.getElementById('status').value || "",
    onlyNewCrit: document.getElementById('onlyNewCrit').value || ""
  };
}

function compare(a,b){
  const dir = (_sortDir === "asc") ? 1 : -1;

  if(_sortKey === "name"){
    return dir * String(a.name||"").localeCompare(String(b.name||""));
  }
  if(_sortKey === "grade"){
    return dir * (rank(a.grade) - rank(b.grade));
  }
  if(_sortKey === "status"){
    return dir * String(a.status||"").localeCompare(String(b.status||""));
  }
  if(_sortKey === "score"){
    return dir * ((a.score??0) - (b.score??0));
  }
  if(_sortKey === "risk"){
    return dir * (riskPct(a.score) - riskPct(b.score));
  }
  if(_sortKey === "newCritical"){
    return dir * ((a.newCritical??0) - (b.newCritical??0));
  }
  // timestamp string ISO compare
  return dir * String(a.timestamp||"").localeCompare(String(b.timestamp||""));
}

function render(){
  const f = getFilters();
  let rows = (window._reports||[]).slice();

  if (f.minGrade) rows = rows.filter(r => rank(r.grade) >= rank(f.minGrade));
  if (f.onlyNewCrit) rows = rows.filter(r => (r.newCritical||0) > 0);
  if (f.status) rows = rows.filter(r => String(r.status||"") === f.status);
  if (f.q) rows = rows.filter(r => JSON.stringify(r).toLowerCase().includes(f.q));

  rows.sort(compare);

  const tb = document.getElementById('tb');
  tb.innerHTML = '';

  rows.forEach(r=>{
    const risk = riskPct(r.score);
    const ts = r.timestamp ? new Date(r.timestamp).toLocaleString() : '';
    const htmlName = (r.name||'').replace('.json','.html');

    const tr = document.createElement('tr');
    tr.className = (r.newCritical||0) > 0 ? 'row hot' : 'row';
    tr.innerHTML = `
      <td>
        <div style="font-weight:600">${r.name||''}</div>
      </td>
      <td>
        <div class="risk">
          <span class="muted">${risk}%</span>
          <div class="riskbar"><div class="riskfill" style="width:${risk}%"></div></div>
        </div>
      </td>
      <td><span class="badge ${gradeClass(r.grade)}">${r.grade||''}</span></td>
      <td>${r.score ?? ''}/100</td>
      <td><span class="badge ${statusClass(r.status)}">${r.status||''}</span></td>
      <td>
  <div class="counts">
    <span class="muted">C:${r.critical??0} H:${r.high??0} M:${r.medium??0} L:${r.low??0}</span>
    <div class="mini" title="Counts">
      ${"<span class='seg c'></span>".repeat(Math.min(10, r.critical||0))}
      ${"<span class='seg h'></span>".repeat(Math.min(10, r.high||0))}
      ${"<span class='seg m'></span>".repeat(Math.min(10, r.medium||0))}
      ${"<span class='seg l'></span>".repeat(Math.min(10, r.low||0))}
    </div>
  </div>
</td>
      <td><span class="badge">${r.newCritical??0}</span></td>
      <td class="muted">${ts}</td>
      <td>
        <a class="btn" href="/reports/${htmlName}" target="_blank">HTML</a>
        <a class="btn" href="/reports/${r.name}" target="_blank">JSON</a>
      </td>
    `;
    tb.appendChild(tr);
  });
}

// header click sorting
document.addEventListener('click', (e)=>{
  const th = e.target.closest('th.sortable');
  if(!th) return;
  const k = th.getAttribute('data-sort');
  if(!k) return;

  if(_sortKey === k) _sortDir = (_sortDir === "asc") ? "desc" : "asc";
  else { _sortKey = k; _sortDir = "desc"; }

  render();
});

function toast(msg){
  const t = document.getElementById('toast');
  if(!t) return;
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(()=> t.style.display='none', 1400);
}

function showScanCommand(){
  const wrap = document.getElementById('scanCmdWrap');
  if(wrap) wrap.style.display = '';

  // ✅ Bu komut: local tool varsayımıyla (dotnet tool veya nupkg ile)
  // Eğer senin tool adı farklıysa burada değiştirirsin.
  const cmd =
`# 1) go to your target project folder
cd "C:\\Path\\To\\Your\\TargetProject"

# 2) run guard scan (example)
guardtool scan --root . --out .\\guardtool-reports

# 3) open dashboard and refresh
# Dashboard reports unlock after first run`;

  const box = document.getElementById('scanCmd');
  if(box) box.textContent = cmd;
}

async function copyScanCmd(){
  const box = document.getElementById('scanCmd');
  if(!box) return;

  const text = box.textContent || "";
  try{
    await navigator.clipboard.writeText(text);
    toast("Copied!");
  }catch{
    // fallback
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    toast("Copied!");
  }
}

load();
</script>