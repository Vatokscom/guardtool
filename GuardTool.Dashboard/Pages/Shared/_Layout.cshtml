<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>@ViewData["Title"] - GuardTool</title>
  <link rel="stylesheet" href="~/css/site.css" />
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="brand-name">GuardTool</div>
        <div class="brand-sub">Local dashboard</div>
      </div>
    </div>

    <nav class="nav">
      <a class="nav-item active" href="/">Events</a>
      <a class="nav-item" href="/reports">Reports</a>
    </nav>

    <div class="sidebar-footer">
      <div class="user-pill">
        <div class="avatar"></div>
        <div class="user-meta">
          <div class="user-name">Local</div>
          <div class="user-sub">Scanner</div>
        </div>
      </div>
    </div>
  </aside>

  <main class="main">
    <header class="topbar">
      <div class="crumbs">Dashboard / @ViewData["Title"]</div>
      <div class="topbar-actions">
        <button class="icon-btn" title="Search" onclick="openGlobalSearch()">ðŸ”Ž</button>
        <button class="icon-btn" title="Notifications" onclick="openNotifications()">ðŸ””</button>
      </div>
    </header>

    <section class="content">
      @RenderBody()
    </section>
  </main>
</div>

<div id="globalSearchBackdrop" class="drawer-backdrop" onclick="closeGlobalSearch()"></div>

<div id="globalSearch" class="drawer" style="left:50%; right:auto; width:600px; transform:translate(-50%, -120%); transition:transform .2s ease;">
  <h2>Global Search</h2>
  <input id="globalSearchInput" class="input" placeholder="Search reports..." />
  <div id="globalSearchResults" style="margin-top:12px;"></div>
</div>

<div id="notifDrawer" class="drawer" style="width:380px;">
  <h2>Notifications</h2>
  <div id="notifContent"></div>
</div>

<script>
function openGlobalSearch(){
  document.getElementById('globalSearchBackdrop').classList.add('open');
  const box = document.getElementById('globalSearch');
  box.style.transform = "translate(-50%, 20%)";
  setTimeout(()=> document.getElementById('globalSearchInput').focus(), 100);
}

function closeGlobalSearch(){
  document.getElementById('globalSearchBackdrop').classList.remove('open');
  document.getElementById('globalSearch').style.transform = "translate(-50%, -120%)";
}

document.addEventListener('keydown', function(e){
  if(e.ctrlKey && e.key.toLowerCase() === 'k'){
    e.preventDefault();
    openGlobalSearch();
  }
});

document.getElementById('globalSearchInput').addEventListener('input', async function(){
  const q = this.value.toLowerCase();
  if(!q){
    document.getElementById('globalSearchResults').innerHTML = '';
    return;
  }

  const res = await fetch('/api/reports');
  const data = await res.json();

  const filtered = data.filter(r =>
    JSON.stringify(r).toLowerCase().includes(q)
  ).slice(0,10);

  document.getElementById('globalSearchResults').innerHTML =
    filtered.map(r => `
      <div style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,.08);cursor:pointer"
           onclick="window.location='/Reports'">
        <strong>${r.name}</strong>
        <div class="small">${r.grade} â€¢ ${r.status}</div>
      </div>
    `).join('');
});

async function openNotifications(){
  const drawer = document.getElementById('notifDrawer');
  drawer.classList.add('open');
  document.getElementById('globalSearchBackdrop').classList.add('open');

  const res = await fetch('/api/reports');
  const data = await res.json();

  const crit = data.filter(r => (r.newCritical||0) > 0);

  if(!crit.length){
    document.getElementById('notifContent').innerHTML =
      "<div class='muted'>No new critical findings ðŸŽ‰</div>";
    return;
  }

  document.getElementById('notifContent').innerHTML =
    crit.map(r => `
      <div style="margin-bottom:12px;padding:10px;border:1px solid rgba(255,70,70,.3);border-radius:12px;">
        <strong>${r.name}</strong>
        <div class="small">${r.newCritical} new critical</div>
      </div>
    `).join('');
}
document.getElementById('globalSearchBackdrop').addEventListener('click', ()=>{
  document.getElementById('notifDrawer').classList.remove('open');
});
</script>

</body>
</html>